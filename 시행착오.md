# SAGA ì‹œí–‰ì°©ì˜¤ ê¸°ë¡

## 1. Anthropic Prompt Caching ë¬´íš¨í™” ë²„ê·¸ (2026-02-25)

### ì¦ìƒ
- `cache_read`ê°€ ë§¤ í„´ 5553 í† í°ì—ì„œ ê³ ì •
- `cache_create`ê°€ ë§¤ í„´ 14000~15000 í† í°ì”© ìƒˆë¡œ ìƒì„±
- Turn 2 ì´í›„ì—ë„ ì´ì „ í„´ì˜ ìºì‹œê°€ ì „í˜€ ì¬ì‚¬ìš©ë˜ì§€ ì•ŠìŒ

```
Turn 1: input=24  cache_read=5553  cache_create=14187
Turn 2: input=9   cache_read=5553  cache_create=14892  â† 14187ì´ ì¬ì‚¬ìš© ì•ˆë¨
Turn 3: input=25  cache_read=5553  cache_create=15573  â† ê³„ì† ìƒˆë¡œ ìƒì„±
```

### ì›ì¸

Anthropic APIì˜ prompt cachingì€ **prefix ê¸°ë°˜**ì´ë‹¤. ì¦‰ ìš”ì²­ì˜ ì²˜ìŒë¶€í„° cache breakpoint(BP)ê¹Œì§€ì˜ ë‚´ìš©ì´ ë™ì¼í•´ì•¼ ìºì‹œê°€ hitëœë‹¤.

`server.py`ì˜ `_build_cacheable_messages()`ì—ì„œ ë™ì  ì»¨í…ìŠ¤íŠ¸(ì—í”¼ì†Œë“œ, ë¡œì–´, ìƒíƒœ ë“±)ë¥¼ `role: "system"` ë©”ì‹œì§€ë¡œ ëŒ€í™” ì¤‘ê°„ì— ì‚½ì…í–ˆë‹¤:

```python
# ë¬¸ì œì˜ ì½”ë“œ
messages.insert(last_user_idx, {
    "role": "system",        # â† ì´ê²Œ ë¬¸ì œ
    "content": context_block, # ë§¤ í„´ ë‚´ìš©ì´ ë°”ë€œ
})
```

ê·¸ëŸ°ë° `llm/client.py`ì˜ `_call_anthropic()`ì—ì„œëŠ” **ëª¨ë“  system ë©”ì‹œì§€ë¥¼ `body["system"]` ë°°ì—´ë¡œ í˜¸ì´ìŠ¤íŒ…**í•œë‹¤:

```python
for msg in messages:
    if msg["role"] == "system":
        system_parts.append(part)  # ì „ë¶€ system ë°°ì—´ë¡œ ì˜¬ë¦¼
    else:
        non_system.append(entry)
```

ê²°ê³¼ì ìœ¼ë¡œ Anthropic APIì— ì „ì†¡ë˜ëŠ” êµ¬ì¡°:

```
system: [
  ì‹œìŠ¤í…œí”„ë¡¬í”„íŠ¸ (BP1, ê³ ì •, 5553 í† í°),     â† cache hit OK
  ë™ì ì»¨í…ìŠ¤íŠ¸ (ë§¤ í„´ ë³€ê²½, ~1500 í† í°)       â† ì´ê²ƒ ë•Œë¬¸ì— BP2 prefix ë³€ê²½!
]
messages: [
  user1,
  assistant1 (BP2),   â† prefixì— ë™ì ì»¨í…ìŠ¤íŠ¸ í¬í•¨ â†’ ìºì‹œ ë¬´íš¨í™”
  user2
]
```

Anthropic cachingì—ì„œ BP2ì˜ ìºì‹œ í‚¤ = `system[0] + system[1] + user1 + assistant1`ì¸ë°, `system[1]`(ë™ì ì»¨í…ìŠ¤íŠ¸)ì´ ë§¤ í„´ ë°”ë€Œë¯€ë¡œ BP2 ìºì‹œê°€ **ì ˆëŒ€ë¡œ hitë˜ì§€ ì•ŠëŠ”ë‹¤**.

5553 í† í°ì˜ `cache_read`ëŠ” BP1(ì‹œìŠ¤í…œí”„ë¡¬í”„íŠ¸)ë§Œ íˆíŠ¸ëœ ê²ƒì´ê³ , ë‚˜ë¨¸ì§€ 14000+ í† í°ì€ ë§¤ë²ˆ ìƒˆë¡œ ìºì‹œë¥¼ ìƒì„±í•˜ê³  ìˆì—ˆë‹¤.

### í•´ê²°

ë™ì  ì»¨í…ìŠ¤íŠ¸ë¥¼ system ë©”ì‹œì§€ê°€ ì•„ë‹Œ **ë§ˆì§€ë§‰ user ë©”ì‹œì§€ì— prepend**í•˜ë„ë¡ ë³€ê²½:

```python
# ìˆ˜ì • í›„
if last_user_idx is not None:
    messages[last_user_idx] = dict(messages[last_user_idx])
    messages[last_user_idx]["content"] = context_block + "\n\n" + messages[last_user_idx]["content"]
```

ìˆ˜ì • í›„ API êµ¬ì¡°:

```
system: [
  ì‹œìŠ¤í…œí”„ë¡¬í”„íŠ¸ (BP1, ê³ ì •)         â† cache hit
]
messages: [
  user1,                            â† ê³ ì •
  assistant1 (BP2),                 â† prefix ê³ ì • â†’ cache hit!
  "ë™ì ì»¨í…ìŠ¤íŠ¸\n\nuser2"           â† BP ë’¤ì— ìœ„ì¹˜, ìºì‹œì— ì˜í–¥ ì—†ìŒ
]
```

### ìˆ˜ì • í›„ ê²°ê³¼

```
Turn 1: input=317   cache_read=5,553   cache_create=15,719  (ì´ˆê¸° ìºì‹œ ìƒì„±)
Turn 2: input=589   cache_read=21,272  cache_create=441     â† 95% ìºì‹œ íˆíŠ¸!
Turn 3: input=809   cache_read=21,713  cache_create=522     â† 96% ìºì‹œ íˆíŠ¸!
Turn 4: input=1,006  cache_read=22,235  cache_create=456     â† 96% ìºì‹œ íˆíŠ¸!
```

Turn 2ë¶€í„° ì´ì „ í„´ì˜ `cache_create`ê°€ ë‹¤ìŒ í„´ì˜ `cache_read`ë¡œ ì „í™˜ë˜ì–´ **~96% ìºì‹œ íˆíŠ¸ìœ¨** ë‹¬ì„±.

### êµí›ˆ

1. **Anthropic APIëŠ” ëª¨ë“  system ë©”ì‹œì§€ë¥¼ messages ì•ì˜ system ë°°ì—´ë¡œ í˜¸ì´ìŠ¤íŒ…í•œë‹¤** â€” ëŒ€í™” ì¤‘ê°„ì— ì‚½ì…í•œ system ë©”ì‹œì§€ë„ ì•ìœ¼ë¡œ ì˜¬ë¼ê°„ë‹¤
2. **Prompt cachingì€ prefix ê¸°ë°˜** â€” cache breakpoint ì´ì „ì˜ ë‚´ìš©ì´ 1 í† í°ì´ë¼ë„ ë°”ë€Œë©´ í•´ë‹¹ BP ì´í›„ ì „ì²´ ìºì‹œê°€ ë¬´íš¨í™”ëœë‹¤
3. **ë™ì  ì»¨í…ìŠ¤íŠ¸ëŠ” ë°˜ë“œì‹œ ëª¨ë“  cache breakpoint ë’¤ì— ë°°ì¹˜**í•´ì•¼ í•œë‹¤ â€” user ë©”ì‹œì§€ì— prependí•˜ëŠ” ê²ƒì´ ê°€ì¥ ì•ˆì „í•œ ë°©ë²•
4. `cache_read`ê°€ ê³ ì •ë˜ì–´ ìˆê³  `cache_create`ê°€ ë§¤ í„´ ë¹„ìŠ·í•œ í¬ê¸°ë¼ë©´ ìºì‹œê°€ ë¬´íš¨í™”ë˜ê³  ìˆë‹¤ëŠ” ì‹ í˜¸

### ìˆ˜ì • íŒŒì¼
- `saga/server.py` â†’ `_build_cacheable_messages()` (lines 286~312)

---

## 2. Prompt Caching ìµœì†Œ í† í° ì„ê³„ê°’ ë¯¸ë‹¬ (2026-02-28)

### ì¦ìƒ
- 3-BP explicit ìºì‹± ì ìš©í–ˆëŠ”ë° `cache_creation_input_tokens`ê°€ í•­ìƒ 0
- `cache_read_input_tokens`ë„ 0 â€” ìºì‹œê°€ ì•„ì˜ˆ ìƒì„±ë˜ì§€ ì•ŠìŒ
- API ì—ëŸ¬ëŠ” ì—†ê³ , ì •ìƒ ì‘ë‹µì€ ì˜´

### ì›ì¸

Anthropicì˜ **ëª¨ë¸ë³„ ìµœì†Œ ìºì‹± í† í° ì„ê³„ê°’**ì„ ê°„ê³¼í•¨:

| ëª¨ë¸ | ìµœì†Œ ìºì‹œ ê°€ëŠ¥ í† í° |
|------|:-----------------:|
| Claude Opus 4.6 / 4.5 | 4096 |
| Claude Sonnet 4.6 | 2048 |
| Claude Sonnet 4.5 / 4 / 3.7 | 1024 |
| **Claude Haiku 4.5** | **4096** |
| Claude Haiku 3.5 / 3 | 2048 |

ë²¤ì¹˜ë§ˆí¬ ì´ˆê¸° ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸ê°€ ~300 í† í° â†’ 2600 í† í°ìœ¼ë¡œ ëŠ˜ë ¸ëŠ”ë°ë„ Haiku 4.5ì˜ 4096 ì„ê³„ê°’ ë¯¸ë‹¬. **ì„ê³„ê°’ ë¯¸ë§Œì´ë©´ `cache_control`ì„ ë‹¬ì•„ë„ ìºì‹œ ìƒì„±/ì½ê¸°ê°€ ì™„ì „íˆ ë¬´ì‹œë¨** (ì—ëŸ¬ ì—†ì´ ì¡°ìš©íˆ ìŠ¤í‚µ).

### í•´ê²°

ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸ë¥¼ ì‹¤ì œ SAGA RP ê·œëª¨(~4100+ í† í°)ë¡œ í™•ì¥í•˜ì—¬ ì„ê³„ê°’ ì´ˆê³¼:

```
ìˆ˜ì • ì „: ~300 í† í° (ê°„ë‹¨í•œ ë‚˜ë ˆì´í„° ì§€ì‹œ)  â†’ cache_creation: 0
ìˆ˜ì • í›„: ~4100 í† í° (ì„¸ê³„ê´€+ìºë¦­í„°+ë£°)     â†’ cache_creation: 4686 âœ“
```

### ìˆ˜ì • í›„ ê²°ê³¼ (50í„´ ë²¤ì¹˜ë§ˆí¬)

```
Turn  1: cache_read=4686  cache_create=0     hit_rate=96.3% (ì´ì „ ì„¸ì…˜ ìºì‹œ ì¬í™œìš©)
Turn  2: cache_read=4686  cache_create=328   hit_rate=90.2%
Turn 10: cache_read=7323  cache_create=328   hit_rate=93.4%
Turn 25: cache_read=12269 cache_create=329   hit_rate=95.7%
Turn 50: cache_read=20500 cache_create=328   hit_rate=97.3%

ì´ ë¹„ìš©: $0.17 (ìºì‹œ ë¯¸ì ìš© ì‹œ $0.72) â†’ 76.7% ì ˆê°
```

### êµí›ˆ

1. **Haiku 4.5ì˜ ìµœì†Œ ìºì‹œ í† í°ì€ 4096** â€” Sonnetë³´ë‹¤ ë†’ë‹¤. ëª¨ë¸ë³„ë¡œ ì„ê³„ê°’ì´ ë‹¤ë¥´ë¯€ë¡œ ë°˜ë“œì‹œ í™•ì¸
2. **ì„ê³„ê°’ ë¯¸ë‹¬ ì‹œ ì—ëŸ¬ê°€ ì•„ë‹ˆë¼ ì¡°ìš©íˆ ìŠ¤í‚µ** â€” `cache_creation: 0`ì´ë©´ í”„ë¡¬í”„íŠ¸ ê¸¸ì´ë¥¼ ì˜ì‹¬í•  ê²ƒ
3. **ì‹¤ì œ RP ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸(~14K í† í°)ì—ì„œëŠ” ë¬¸ì œì—†ìŒ** â€” ë²¤ì¹˜ë§ˆí¬ìš© ì§§ì€ í”„ë¡¬í”„íŠ¸ì—ì„œë§Œ ë°œìƒí•˜ëŠ” ì´ìŠˆ

---

## 3. ìë™ ìºì‹±(top-level) vs ìˆ˜ë™ 3-BP: ì¥ê¸° ëŒ€í™”ì—ì„œì˜ ì°¨ì´ (2026-02-28)

### ì¦ìƒ
- Anthropicì˜ ìƒˆë¡œìš´ **automatic caching** (top-level `cache_control`)ì„ í…ŒìŠ¤íŠ¸
- í„´ 1-11ê¹Œì§€ëŠ” ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸(4686 í† í°) ìºì‹œ ì½ê¸° ì‘ë™
- **í„´ 12ë¶€í„° cache_readê°€ ì™„ì „íˆ 0**ìœ¼ë¡œ ë–¨ì–´ì§
- ê²°ê³¼: ìºì‹œ ë¯¸ì ìš© ëŒ€ë¹„ **-15% (ì˜¤íˆë ¤ ë¹„ìš© ì¦ê°€)**

```
Turn 11: cache_read=4686  cache_create=3496   hit_rate=57.3%
Turn 12: cache_read=0     cache_create=8517   hit_rate=0.0%  â† ê°‘ìê¸° 0
Turn 50: cache_read=0     cache_create=21061  hit_rate=0.0%
```

### ì›ì¸

Anthropic automatic cachingì˜ **20-block lookback ì œí•œ**:

```
ìë™ ìºì‹± = ë§ˆì§€ë§‰ ë©”ì‹œì§€ì—ì„œ ì—­ë°©í–¥ìœ¼ë¡œ ìµœëŒ€ 20ë¸”ë¡ë§Œ ê²€ì‚¬

í„´ 12 ì‹œì : system(1) + user(11) + assistant(11) + user(1) = 24 ë©”ì‹œì§€
â†’ ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸ê°€ ë§ˆì§€ë§‰ì—ì„œ 24ë²ˆì§¸ = lookback 20 ë²”ìœ„ ë°–!
â†’ ìºì‹œ ë¯¸ìŠ¤ â†’ ë§¤ í„´ ì „ì²´ë¥¼ cache_create (20000+ í† í°)
```

ë°˜ë©´ **ìˆ˜ë™ 3-BP**ëŠ” system, ì¤‘ê°„ assistant, ë§ˆì§€ë§‰ assistantì— **ëª…ì‹œì  breakpoint**ë¥¼ ë°°ì¹˜í•˜ë¯€ë¡œ, 20-block ì œí•œê³¼ ë¬´ê´€í•˜ê²Œ í•­ìƒ ìºì‹œ íˆíŠ¸.

### ì—°ì† ì‹¤í–‰ ë¹„êµ ê²°ê³¼ (ë™ì¼ ì„¸ì…˜, back-to-back)

3-BP 50í„´ â†’ ìë™ ìºì‹± 42í„´(í„´ 43ì—ì„œ 529 Overloaded ì—ëŸ¬ë¡œ ì¤‘ë‹¨)ì„ ì—°ì† ì‹¤í–‰í•˜ì—¬ ë¹„êµ.

| ì§€í‘œ | ìˆ˜ë™ 3-BP (50í„´) | ìë™ top-level (42í„´) |
|------|:----------------:|:---------------------:|
| í‰ê·  íˆíŠ¸ìœ¨ (í„´ 5+) | **95.5%** | 12.1% |
| ì´ ë¹„ìš© | **$0.17** | $0.62 |
| ìºì‹œ ë¯¸ì ìš© ëŒ€ë¹„ ë¹„ìš© | $0.72 | $0.55 |
| ì ˆê°ë¥  | **76.0%** | **-11.4% (ë” ë¹„ìŒˆ)** |

**ìë™ ìºì‹±ì˜ ì¶”ê°€ ë¬¸ì œ**: í„´ 43ì—ì„œ Anthropic APIê°€ `529 Overloaded` ì—ëŸ¬ë¥¼ ë°˜í™˜í•˜ë©° ì¤‘ë‹¨ë¨. ìë™ ìºì‹±ì€ ë§¤ í„´ ì „ì²´ ëŒ€í™”ë¥¼ `cache_create`í•˜ë¯€ë¡œ (18000+ í† í°/í„´), API ì²˜ë¦¬ëŸ‰ í•œê³„ì— ë„ë‹¬í•  ìˆ˜ ìˆìŒ.

### êµí›ˆ

1. **ì¥ê¸° RP ëŒ€í™”(20í„´+)ì—ì„œëŠ” ìˆ˜ë™ 3-BPê°€ í•„ìˆ˜** â€” ìë™ ìºì‹±ì€ ì§§ì€ ëŒ€í™”ì—ë§Œ ìœ íš¨
2. **20-block lookback ì œí•œ**ì„ ë°˜ë“œì‹œ ì¸ì§€í•  ê²ƒ â€” ëŒ€í™” ë©”ì‹œì§€ê°€ 20ê°œë¥¼ ë„˜ìœ¼ë©´ ìë™ ìºì‹±ì˜ ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸ íˆíŠ¸ê°€ ë¶ˆê°€ëŠ¥
3. **ìë™ ìºì‹±ì€ ë¹„ìš© ì¦ê°€ + API ë¶ˆì•ˆì •** â€” cache_create í”„ë¦¬ë¯¸ì—„(25%)ì´ ë§¤ í„´ ì „ì²´ì— ì ìš©ë˜ì–´ ìºì‹œ ì—†ëŠ” ê²½ìš°ë³´ë‹¤ ë¹„ìŒˆ. ë˜í•œ ëŒ€ëŸ‰ cache_createë¡œ 529 Overloaded ë°œìƒ ê°€ëŠ¥
4. **SAGAì˜ 3-BP ì„¤ê³„ê°€ ì •í™•íˆ ë§ëŠ” ì „ëµ** â€” ëª…ì‹œì  breakpointë¡œ ì‹œìŠ¤í…œ/ì¤‘ê°„/ë§ˆì§€ë§‰ ì§€ì ì„ ê³ ì •í•˜ë¯€ë¡œ ëŒ€í™” ê¸¸ì´ì— ë¬´ê´€

### ì£¼ì˜: ë²¤ì¹˜ë§ˆí¬ ìŠ¤í† ë¦¬ í’ˆì§ˆ ì°¨ì´

íŠ¸ë ˆì´ìŠ¤ë¥¼ ë¹„êµí•˜ë©´ Auto-cache ìª½ ì„œì‚¬ê°€ ë” í’ë¶€í•´ ë³´ì¸ë‹¤ (void-amulet 20í„´ ì—°ì† ì°¸ì¡°, Shadow Guild 9í„´ ë“±ì¥ vs 3-BPëŠ” ë°˜ë³µ ìˆ˜ë ´). **ì´ê²ƒì€ ìºì‹± ë©”ì»¤ë‹ˆì¦˜ì˜ ì°¨ì´ê°€ ì•„ë‹ˆë¼ í™•ë¥ ì  ë¶„ê¸°(stochastic divergence)** ë•Œë¬¸:

- ë‘ ëª¨ë“œëŠ” **ë™ì¼í•œ ë©”ì‹œì§€ ë‚´ìš©**ì„ APIì— ì „ì†¡ (ë©”ì‹œì§€ ìˆ˜, í…ìŠ¤íŠ¸ ê¸¸ì´ ëª¨ë‘ ì¼ì¹˜)
- Turn 1ì—ì„œ temperature=0.7ë¡œ ì„œë¡œ ë‹¤ë¥¸ ì´ˆê¸° ì‘ë‹µ â†’ ì´í›„ ëŒ€í™” íˆìŠ¤í† ë¦¬ê°€ ì™„ì „íˆ ê°ˆë¼ì§
- 3-BP ëŸ°ì€ 10ê°œ ìˆœí™˜ ì…ë ¥ì— ëŒ€í•´ ëª¨ë¸ì´ "ê³ ì •ì "ì— ìˆ˜ë ´ (Turn 21==31 ë°”ì´íŠ¸ ë™ì¼, ì´ 5ìŒ)
- Auto-cache ëŸ°ì€ ìš°ì—°íˆ ë” í’ë¶€í•œ ì„œì‚¬ ê¶¤ì ì„ ìƒì„±

ìºì‹± breakpointëŠ” API ë°±ì—”ë“œ ìµœì í™”ì¼ ë¿ ëª¨ë¸ ì¶œë ¥ì— ì˜í–¥ì„ ì£¼ì§€ ì•Šìœ¼ë¯€ë¡œ, **ë¹„ìš©/í† í° ë²¤ì¹˜ë§ˆí¬ ê²°ê³¼ëŠ” ìœ íš¨**í•˜ë‹¤. ìŠ¤í† ë¦¬ í’ˆì§ˆì€ ë²¤ì¹˜ë§ˆí¬ì˜ ì¸¡ì • ëŒ€ìƒì´ ì•„ë‹ˆë©°, ì‹¤ì œ SAGAì—ì„œëŠ” ìœ ì €ê°€ ë§¤ í„´ ë‹¤ë¥¸ ì…ë ¥ì„ í•˜ë¯€ë¡œ ìˆœí™˜ ìˆ˜ë ´ ë¬¸ì œê°€ ë°œìƒí•˜ì§€ ì•ŠëŠ”ë‹¤.

### ë²¤ì¹˜ë§ˆí¬ ìŠ¤í¬ë¦½íŠ¸
- `tests/bench_prompt_caching.py` â€” 3-BP / ìë™ / no-cache ëª¨ë“œ ì§€ì›, `--trace` í”Œë˜ê·¸ë¡œ ì „ì²´ I/O íŠ¸ë ˆì´ì‹± ê°€ëŠ¥
- `tests/bench_report_3bp.{txt,json}` â€” ìˆ˜ë™ 3-BP 50í„´ ë°ì´í„°
- `tests/bench_report_auto.{txt,json}` â€” ìë™ ìºì‹± 42í„´ ë°ì´í„° (í„´ 43 529 ì—ëŸ¬ë¡œ ì¤‘ë‹¨)
- `tests/bench_trace_3bp.json` â€” ìˆ˜ë™ 3-BP ì „ì²´ I/O íŠ¸ë ˆì´ìŠ¤
- `tests/bench_trace_auto.json` â€” ìë™ ìºì‹± ì „ì²´ I/O íŠ¸ë ˆì´ìŠ¤

---

## 4. Starlette StreamingResponse cancel scopeê°€ Sub-Bë¥¼ ì£½ì´ëŠ” ë¬¸ì œ (2026-03-02)

### ì¦ìƒ
- E2E í…ŒìŠ¤íŠ¸ì—ì„œ Sub-B(PostTurnExtractor)ê°€ **í•œ ë²ˆë„ ì‹¤í–‰ë˜ì§€ ì•ŠìŒ**
- `[DEBUG Sub-B]` ë¡œê·¸ê°€ ì „í˜€ ì¶œë ¥ë˜ì§€ ì•ŠìŒ
- SSE ìŠ¤íŠ¸ë¦¬ë°ì€ ì •ìƒ ì‘ë™, í´ë¼ì´ì–¸íŠ¸ë„ ì‘ë‹µì„ ì •ìƒ ìˆ˜ì‹ 
- live_state.mdê°€ ì˜ì›íˆ ì´ˆê¸°ê°’(unknown/ì—†ìŒ)ìœ¼ë¡œ ë‚¨ìŒ
- 8/17 E2E ê²€ì¦ í•­ëª© FAIL

### ì›ì¸

Starletteì˜ `StreamingResponse`ëŠ” ë‚´ë¶€ì ìœ¼ë¡œ `anyio.create_task_group()`ìœ¼ë¡œ cancel scopeë¥¼ ìƒì„±í•œë‹¤. ì´ scope ì•ˆì—ì„œ `_stream_response` async generatorì™€ `listen_for_disconnect` íƒœìŠ¤í¬ê°€ ë™ì‹œì— ì‹¤í–‰ëœë‹¤.

ë¬¸ì œëŠ” í´ë¼ì´ì–¸íŠ¸ê°€ `[DONE]` ìˆ˜ì‹  í›„ ì—°ê²°ì„ ëŠìœ¼ë©´, `listen_for_disconnect`ê°€ ì´ë¥¼ ê°ì§€í•˜ì—¬ **cancel scope ì „ì²´ë¥¼ ì·¨ì†Œ**í•œë‹¤ëŠ” ê²ƒì´ë‹¤. generatorì˜ `yield "data: [DONE]\n\n"` ì´í›„ì— ë°°ì¹˜í•œ post-yield ì½”ë“œ(Sub-B ì‹¤í–‰, í„´ ì¹´ìš´í„° ì¦ê°€ ë“±)ëŠ” cancel scopeì— ì˜í•´ **ì¡°ìš©íˆ ì£½ëŠ”ë‹¤**.

```python
# ë¬¸ì œì˜ ì½”ë“œ êµ¬ì¡°
async def _stream_response(...):
    # ... ì²­í¬ ìŠ¤íŠ¸ë¦¬ë° ...
    yield "data: [DONE]\n\n"

    # â†“ ì´ ì½”ë“œëŠ” Starlette cancel scopeì— ì˜í•´ ì ˆëŒ€ ì‹¤í–‰ë˜ì§€ ì•ŠìŒ!
    turn_number = await sqlite_db.increment_turn(session_id)
    task_b = asyncio.create_task(post_turn.extract_and_update(...))
```

Uvicorn ASGI spec_version "2.3"ì—ì„œ Starletteê°€ cancel scopeë¥¼ ì‚¬ìš©í•˜ê¸° ì‹œì‘í•œ ê²ƒì´ ê·¼ë³¸ ì›ì¸ì´ë‹¤. ì´ì „ ë²„ì „ì—ì„œëŠ” post-yield ì½”ë“œê°€ ì‹¤í–‰ë  ìˆ˜ ìˆì—ˆìœ¼ë‚˜, ìµœì‹  ë²„ì „ì—ì„œëŠ” ë¶ˆê°€ëŠ¥í•˜ë‹¤.

### í•´ê²°

`starlette.background.BackgroundTask`ë¥¼ ì‚¬ìš©í•˜ì—¬ post-stream ì²˜ë¦¬ë¥¼ **ì‘ë‹µ ë¼ì´í”„ì‚¬ì´í´ ì™„ì „íˆ ì´í›„ì—** ì‹¤í–‰ë˜ë„ë¡ ë³€ê²½:

```python
from starlette.background import BackgroundTask

# 1. mutable dictë¡œ generator â†’ BackgroundTask ê°„ ë°ì´í„° ì „ë‹¬
stream_ctx = {"full_response": ""}

# 2. BackgroundTaskë¡œ post-stream ë¡œì§ ë¶„ë¦¬
async def _post_stream_task():
    full_response = stream_ctx["full_response"]
    if not full_response:
        return  # í´ë¼ì´ì–¸íŠ¸ ì¡°ê¸° ì—°ê²° ëŠê¹€
    turn_number = await sqlite_db.increment_turn(session_id)
    task_b = asyncio.create_task(post_turn.extract_and_update(...))
    _background_tasks.add(task_b)  # GC ë°©ì§€
    task_b.add_done_callback(_background_tasks.discard)

# 3. StreamingResponseì— background íŒŒë¼ë¯¸í„° ì „ë‹¬
return StreamingResponse(
    _stream_response(stream_ctx=stream_ctx, ...),
    media_type="text/event-stream",
    background=BackgroundTask(_post_stream_task),
)
```

ì¶”ê°€ë¡œ, í´ë¼ì´ì–¸íŠ¸ disconnect ì‹œì—ë„ `full_response`ê°€ ë¹„ì–´ìˆì§€ ì•Šë„ë¡ **generator ë‚´ë¶€ì—ì„œ ë§¤ ì²­í¬ë§ˆë‹¤ incremental ì—…ë°ì´íŠ¸**:

```python
# generator ë‚´ë¶€
async for chunk in response_stream:
    full_response += chunk
    stream_ctx["full_response"] = full_response  # disconnect ë°©ì–´
    yield f"data: {json.dumps(...)}\n\n"
```

### ìˆ˜ì • í›„ ê²°ê³¼

```
ìˆ˜ì • ì „: 8/17 FAIL (Sub-B ë¯¸ì‹¤í–‰ â†’ live_state.md ì´ˆê¸°ê°’, SQLite ë¯¸ê°±ì‹ )
ìˆ˜ì • í›„: 17/17 ALL PASS (23í„´ ë˜ì „ ì‹œë‚˜ë¦¬ì˜¤ í¬í•¨)

[DEBUG Sub-B] â–¶ Task started for turn 1, session=b67e53a1fff9bb86
[Sub-B] ğŸ”’ Lock acquired for turn 1
[Sub-B] Turn 1 post-processing complete (importance=55, method=regex)
```

### êµí›ˆ

1. **Starlette StreamingResponseì˜ post-yield ì½”ë“œëŠ” ì‹¤í–‰ì´ ë³´ì¥ë˜ì§€ ì•ŠëŠ”ë‹¤** â€” cancel scopeì— ì˜í•´ ì–¸ì œë“  ì·¨ì†Œë  ìˆ˜ ìˆìŒ
2. **`BackgroundTask`ëŠ” ì‘ë‹µ ë¼ì´í”„ì‚¬ì´í´(cancel scope í¬í•¨) ì™„ì „íˆ ì´í›„ì— ì‹¤í–‰ëœë‹¤** â€” post-stream ì²˜ë¦¬ì˜ ìœ ì¼í•œ ì•ˆì „í•œ ìœ„ì¹˜
3. **`_background_tasks` set íŒ¨í„´**: `asyncio.create_task()`ë¡œ fire-and-forget íƒœìŠ¤í¬ë¥¼ ìƒì„±í•˜ë©´, ì´ë²¤íŠ¸ ë£¨í”„ê°€ ì•½í•œ ì°¸ì¡°ë§Œ ìœ ì§€í•˜ì—¬ GCì— ìˆ˜ê±°ë  ìˆ˜ ìˆìŒ. setì— ì¶”ê°€í•˜ê³  `done_callback`ìœ¼ë¡œ ì œê±°í•˜ëŠ” íŒ¨í„´ì´ í•„ìˆ˜
4. **mutable dict íŒ¨í„´**: generatorì™€ BackgroundTask ê°„ ë°ì´í„° ì „ë‹¬ì—ëŠ” mutable container(dict)ë¥¼ ì‚¬ìš©. generator ë‚´ë¶€ì—ì„œ ë§¤ ì²­í¬ë§ˆë‹¤ ì—…ë°ì´íŠ¸í•˜ë©´ disconnectì—ë„ ë¶€ë¶„ ë°ì´í„° í™•ë³´ ê°€ëŠ¥

### ìˆ˜ì • íŒŒì¼
- `saga/server.py` â€” `_stream_response()` generatorì—ì„œ post-yield ì½”ë“œ ì œê±°, `_post_stream_task()` + `BackgroundTask` ë„ì…

---

## 5. Python dict.get() NoneType ë²„ê·¸ â€” í‚¤ê°€ ì¡´ì¬í•˜ë˜ ê°’ì´ Noneì¸ ê²½ìš° (2026-03-02)

### ì¦ìƒ
- Sub-Bì—ì„œ ê°„í—ì  `TypeError: unsupported operand type(s) for +: 'NoneType' and 'int'` ë°œìƒ
- `relationship_changes`ì˜ `delta` í•„ë“œ ì²˜ë¦¬ ì¤‘ ì—ëŸ¬
- LLMì´ state blockì—ì„œ `delta: null`ì„ ì¶œë ¥í•œ ê²½ìš°ì—ë§Œ ë°œìƒ

### ì›ì¸

Pythonì˜ `dict.get(key, default)` ë™ì‘ì˜ ë¯¸ë¬˜í•œ í•¨ì •:

```python
# í‚¤ê°€ ì—†ì„ ë•Œ: default ë°˜í™˜ â†’ OK
{"foo": 1}.get("bar", 0)  # â†’ 0 âœ“

# í‚¤ê°€ ì¡´ì¬í•˜ë˜ ê°’ì´ Noneì¼ ë•Œ: None ë°˜í™˜ â†’ default ë¬´ì‹œ!
{"delta": None}.get("delta", 0)  # â†’ None âœ— (0ì´ ì•„ë‹˜!)
```

LLMì´ `delta: null`(JSON null â†’ Python None)ì„ ì¶œë ¥í•˜ë©´, `get("delta", 0)`ì€ `None`ì„ ë°˜í™˜í•œë‹¤. ì´ê±¸ ì‚°ìˆ  ì—°ì‚°ì— ì‚¬ìš©í•˜ë©´ `TypeError` ë°œìƒ.

### í•´ê²°

`(x.get("key") or default)` íŒ¨í„´ìœ¼ë¡œ í†µì¼:

```python
# ìˆ˜ì • ì „ â€” Noneì´ ê·¸ëŒ€ë¡œ í†µê³¼
change.get("delta", 0)          # â†’ None (í‚¤ ì¡´ì¬, ê°’ None)

# ìˆ˜ì • í›„ â€” Noneì´ 0ìœ¼ë¡œ ë³€í™˜
(change.get("delta") or 0)      # â†’ 0 âœ“
```

`post_turn.py` ì „ì²´ì— ì ìš©:
- `change.get("from", "")` â†’ `(change.get("from") or "")`
- `change.get("to", "")` â†’ `(change.get("to") or "")`
- `change.get("type", "")` â†’ `(change.get("type") or "")`
- `change.get("delta", 0)` â†’ `(change.get("delta") or 0)`
- `state_block.get("location", "unknown")` â†’ `(state_block.get("location") or "unknown")`

### êµí›ˆ

1. **LLM ì¶œë ¥ì€ í•­ìƒ `null` ê°€ëŠ¥ì„±ì´ ìˆë‹¤** â€” JSONì—ì„œ `null`ì€ ìœ íš¨í•œ ê°’ì´ë¯€ë¡œ, dictì— í‚¤ê°€ ì¡´ì¬í•˜ë˜ `None`ì¸ ê²½ìš°ê°€ í”í•¨
2. **`dict.get(key, default)`ì˜ defaultëŠ” "í‚¤ ë¶€ì¬" ì‹œì—ë§Œ ë™ì‘** â€” í‚¤ê°€ ì¡´ì¬í•˜ê³  ê°’ì´ `None`ì´ë©´ `None`ì„ ë°˜í™˜
3. **`(x or default)` íŒ¨í„´ì´ LLM ì¶œë ¥ íŒŒì‹±ì— ë” ì•ˆì „** â€” `None`, `""`, `0`, `[]`, `False` ëª¨ë‘ falsyë¡œ ì²˜ë¦¬
4. **ì´ íŒ¨í„´ì€ LLM íŒŒì‹± ì½”ë“œ ì „ì²´ì— ì¼ê´€ ì ìš©í•´ì•¼ í•œë‹¤** â€” í•˜ë‚˜ë§Œ ê³ ì¹˜ë©´ ë‹¤ë¥¸ ê³³ì—ì„œ ê°™ì€ ë¬¸ì œ ë°˜ë³µ

### ìˆ˜ì • íŒŒì¼
- `saga/agents/post_turn.py` â€” `_update_state_db()`, `_record_episode()` ë‚´ dict.get() í˜¸ì¶œ
